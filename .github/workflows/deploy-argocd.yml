name: deploy-argo-cd-to-GKE

on:
  workflow_dispatch:
    inputs:
      install:
        description: 'Install new argocd?'
        required: true
        type: boolean
        default: false

env:
  PROJECT_ID: devops-asm
  GKE_CLUSTER: gke-cluster 
  GKE_ZONE: asia-southeast1-b

jobs:
  deploy-argocd:
    name: deploy-argocd
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_CREDS }}


    
    - uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}


   
    - name: Install
      if: ${{ inputs.install == true }}
      run: |-
        kubectl apply -f ./ArgoCD/installation/ -n argocd
    
    - name: Deploy app
      run: |-
        kubectl apply -f ./ArgoCD/resource/ -n argocd
